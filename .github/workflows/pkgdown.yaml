# Workflow to build pkgdown site, which lives at https://wilkox.org/treemapify.
# Deployment is via the gh-pages branch.

# Define when the Workflow runs: on pushes to main and master (builds and
# deploys), and on pull requests (builds only)
on:
  release:
    types: [published]
  workflow_dispatch:

name: pkgdown-build-and-deploy

permissions: read-all

jobs:
  pkgdown:
    runs-on: ubuntu-latest
    concurrency:
      group: pkgdown-${{ github.event_name != 'pull_request' || github.run_id }}
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write

    # Only build site for the latest tagged release, not for every version
    steps:
      - name: Get latest release tag
        id: latest_release
        if: github.event_name == 'workflow_dispatch'
        run: |
          LATEST_TAG=$(gh release view --json tagName -q .tagName)
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && steps.latest_release.outputs.tag || github.ref }}

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::pkgdown, local::.
          needs: website

      - name: Build site
        run: pkgdown::build_site_github_pages(new_process = FALSE, install = FALSE)
        shell: Rscript {0}

      - name: Deploy to GitHub pages ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          clean: false
          branch: gh-pages
          folder: docs
